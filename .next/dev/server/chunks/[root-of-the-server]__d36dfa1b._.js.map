{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Tejab/Desktop/final_year_project/TRACKSHEET/UI/lib/mongodb.ts"],"sourcesContent":["import { MongoClient } from \"mongodb\";\r\n\r\nconst uri = process.env.MONGODB_URI;\r\n\r\nif (!uri) {\r\n  throw new Error(\"Missing MONGODB_URI in environment\");\r\n}\r\n\r\nlet client: MongoClient | null = null;\r\nlet clientPromise: Promise<MongoClient> | null = null;\r\n\r\nexport async function getMongoClient(): Promise<MongoClient> {\r\n  if (client) return client;\r\n  if (!clientPromise) {\r\n    clientPromise = new MongoClient(uri).connect();\r\n  }\r\n  client = await clientPromise;\r\n  return client;\r\n}\r\n\r\nexport async function getDb() {\r\n  const mongoClient = await getMongoClient();\r\n  return mongoClient.db();\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AAEnC,IAAI,CAAC,KAAK;IACR,MAAM,IAAI,MAAM;AAClB;AAEA,IAAI,SAA6B;AACjC,IAAI,gBAA6C;AAE1C,eAAe;IACpB,IAAI,QAAQ,OAAO;IACnB,IAAI,CAAC,eAAe;QAClB,gBAAgB,IAAI,sHAAW,CAAC,KAAK,OAAO;IAC9C;IACA,SAAS,MAAM;IACf,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM;IAC1B,OAAO,YAAY,EAAE;AACvB","debugId":null}},
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Tejab/Desktop/final_year_project/TRACKSHEET/UI/lib/auth.ts"],"sourcesContent":["import jwt from \"jsonwebtoken\";\r\n\r\nexport type AuthTokenPayload = {\r\n  role: \"student\" | \"staff\";\r\n  rollNumber?: string;\r\n  staffId?: string;\r\n  email: string;\r\n};\r\n\r\nconst jwtSecret = process.env.JWT_SECRET;\r\nconst jwtExpiresIn = process.env.JWT_EXPIRES_IN || \"7d\";\r\n\r\nif (!jwtSecret) {\r\n  throw new Error(\"Missing JWT_SECRET in environment\");\r\n}\r\n\r\nexport function signAuthToken(payload: AuthTokenPayload) {\r\n  return jwt.sign(payload, jwtSecret, { expiresIn: jwtExpiresIn });\r\n}\r\n\r\nexport function verifyAuthToken(token: string): AuthTokenPayload {\r\n  return jwt.verify(token, jwtSecret) as AuthTokenPayload;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AASA,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU;AACxC,MAAM,eAAe,QAAQ,GAAG,CAAC,cAAc,IAAI;AAEnD,IAAI,CAAC,WAAW;IACd,MAAM,IAAI,MAAM;AAClB;AAEO,SAAS,cAAc,OAAyB;IACrD,OAAO,2MAAG,CAAC,IAAI,CAAC,SAAS,WAAW;QAAE,WAAW;IAAa;AAChE;AAEO,SAAS,gBAAgB,KAAa;IAC3C,OAAO,2MAAG,CAAC,MAAM,CAAC,OAAO;AAC3B","debugId":null}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Tejab/Desktop/final_year_project/TRACKSHEET/UI/lib/auth-server.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport { AuthTokenPayload, verifyAuthToken } from \"./auth\";\r\n\r\nconst COOKIE_NAME = \"tracksheet_token\";\r\n\r\nexport function getAuthFromRequest(request: NextRequest): AuthTokenPayload | null {\r\n  const token = request.cookies.get(COOKIE_NAME)?.value;\r\n  if (!token) return null;\r\n  try {\r\n    return verifyAuthToken(token);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function getAuthCookieName() {\r\n  return COOKIE_NAME;\r\n}\r\n"],"names":[],"mappings":";;;;;;AACA;;AAEA,MAAM,cAAc;AAEb,SAAS,mBAAmB,OAAoB;IACrD,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,cAAc;IAChD,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,IAAA,gIAAe,EAAC;IACzB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS;IACd,OAAO;AACT","debugId":null}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Tejab/Desktop/final_year_project/TRACKSHEET/UI/app/api/student/%5BrollNumber%5D/update/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getDb } from \"@/lib/mongodb\";\r\nimport { getAuthFromRequest } from \"@/lib/auth-server\";\r\n\r\nconst normalizeBranch = (value: string | undefined) =>\r\n  (value || \"\").trim().toUpperCase();\r\n\r\nasync function checkAuth(request: NextRequest, rollNumber: string) {\r\n  const auth = getAuthFromRequest(request);\r\n  if (!auth) {\r\n    return { authorized: false, error: \"Unauthorized\" };\r\n  }\r\n\r\n  if (auth.role === \"student\" && auth.rollNumber !== rollNumber) {\r\n    return { authorized: false, error: \"Forbidden\" };\r\n  }\r\n\r\n  const db = await getDb();\r\n  const profiles = db.collection(\"sProfile\");\r\n  const profileDoc = await profiles.findOne({ \"Roll no\": rollNumber });\r\n\r\n  if (!profileDoc) {\r\n    return { authorized: false, error: \"Student not found\" };\r\n  }\r\n\r\n  if (auth.role === \"staff\") {\r\n    const staffBranchMap = db.collection(\"staffBranchMap\");\r\n    const branches = db.collection(\"branches\");\r\n    const mapping = await staffBranchMap.findOne({ staffId: auth.staffId });\r\n    const branch = mapping?.branchId\r\n      ? await branches.findOne({ branchId: mapping.branchId })\r\n      : null;\r\n    const staffBranchKey = normalizeBranch(branch?.branchName || branch?.branchId);\r\n    const studentBranchKey = normalizeBranch(String(profileDoc[\"Branch\"] || \"\"));\r\n\r\n    if (!staffBranchKey || staffBranchKey !== studentBranchKey) {\r\n      return { authorized: false, error: \"Forbidden\" };\r\n    }\r\n  }\r\n\r\n  return { authorized: true, profileDoc };\r\n}\r\n\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ rollNumber: string }> }\r\n) {\r\n  try {\r\n    const resolvedParams = await params;\r\n    const rollNumber = decodeURIComponent(resolvedParams.rollNumber || \"\").trim();\r\n    if (!rollNumber) {\r\n      return NextResponse.json({ error: \"Missing roll number\" }, { status: 400 });\r\n    }\r\n\r\n    const { authorized, error, profileDoc } = await checkAuth(request, rollNumber);\r\n    if (!authorized || !profileDoc) {\r\n      const statusCode = error === \"Unauthorized\" ? 401 : error === \"Forbidden\" ? 403 : 404;\r\n      return NextResponse.json({ error }, { status: statusCode });\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { section, data } = body;\r\n\r\n    if (!section || !data) {\r\n      return NextResponse.json({ error: \"Missing section or data\" }, { status: 400 });\r\n    }\r\n\r\n    const db = await getDb();\r\n    const fullName = String(profileDoc[\"Full name\"] || \"\");\r\n\r\n    // Map section names to collection and field updates\r\n    const collectionMap: Record<string, { collection: string; query: Record<string, unknown>; updates: Record<string, unknown> }> = {\r\n      profile: {\r\n        collection: \"sProfile\",\r\n        query: { \"Roll no\": rollNumber },\r\n        updates: {\r\n          \"Date of Birth\": data.dob || undefined,\r\n          \"Address\": data.address || undefined,\r\n          \"Parent Name\": data.parentName || undefined,\r\n          \"Parent Phone\": data.parentPhone || undefined,\r\n        },\r\n      },\r\n      academic: {\r\n        collection: \"sAcademics\",\r\n        query: fullName ? { \"Full name\": fullName } : { \"Roll no\": rollNumber },\r\n        updates: data,\r\n      },\r\n      cocircular: {\r\n        collection: \"sCociruculars\",\r\n        query: fullName ? { \"Full name\": fullName } : { \"Roll no\": rollNumber },\r\n        updates: data,\r\n      },\r\n      extracircular: {\r\n        collection: \"sEcirculars\",\r\n        query: fullName ? { \"Full name\": fullName } : { \"Roll no\": rollNumber },\r\n        updates: data,\r\n      },\r\n    };\r\n\r\n    const config = collectionMap[section];\r\n    if (!config) {\r\n      return NextResponse.json({ error: \"Invalid section\" }, { status: 400 });\r\n    }\r\n\r\n    const collection = db.collection(config.collection);\r\n    const cleanedUpdates = Object.fromEntries(\r\n      Object.entries(config.updates).filter(([_, v]) => v !== undefined)\r\n    );\r\n\r\n    const result = await collection.updateOne(config.query, { $set: cleanedUpdates });\r\n\r\n    if (result.matchedCount === 0) {\r\n      return NextResponse.json({ error: \"Student data not found\" }, { status: 404 });\r\n    }\r\n\r\n    return NextResponse.json({ success: true, message: `${section} updated successfully` });\r\n  } catch (error) {\r\n    console.error(\"PATCH error:\", error);\r\n    return NextResponse.json(\r\n      { error: error instanceof Error ? error.message : \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,kBAAkB,CAAC,QACvB,CAAC,SAAS,EAAE,EAAE,IAAI,GAAG,WAAW;AAElC,eAAe,UAAU,OAAoB,EAAE,UAAkB;IAC/D,MAAM,OAAO,IAAA,6IAAkB,EAAC;IAChC,IAAI,CAAC,MAAM;QACT,OAAO;YAAE,YAAY;YAAO,OAAO;QAAe;IACpD;IAEA,IAAI,KAAK,IAAI,KAAK,aAAa,KAAK,UAAU,KAAK,YAAY;QAC7D,OAAO;YAAE,YAAY;YAAO,OAAO;QAAY;IACjD;IAEA,MAAM,KAAK,MAAM,IAAA,yHAAK;IACtB,MAAM,WAAW,GAAG,UAAU,CAAC;IAC/B,MAAM,aAAa,MAAM,SAAS,OAAO,CAAC;QAAE,WAAW;IAAW;IAElE,IAAI,CAAC,YAAY;QACf,OAAO;YAAE,YAAY;YAAO,OAAO;QAAoB;IACzD;IAEA,IAAI,KAAK,IAAI,KAAK,SAAS;QACzB,MAAM,iBAAiB,GAAG,UAAU,CAAC;QACrC,MAAM,WAAW,GAAG,UAAU,CAAC;QAC/B,MAAM,UAAU,MAAM,eAAe,OAAO,CAAC;YAAE,SAAS,KAAK,OAAO;QAAC;QACrE,MAAM,SAAS,SAAS,WACpB,MAAM,SAAS,OAAO,CAAC;YAAE,UAAU,QAAQ,QAAQ;QAAC,KACpD;QACJ,MAAM,iBAAiB,gBAAgB,QAAQ,cAAc,QAAQ;QACrE,MAAM,mBAAmB,gBAAgB,OAAO,UAAU,CAAC,SAAS,IAAI;QAExE,IAAI,CAAC,kBAAkB,mBAAmB,kBAAkB;YAC1D,OAAO;gBAAE,YAAY;gBAAO,OAAO;YAAY;QACjD;IACF;IAEA,OAAO;QAAE,YAAY;QAAM;IAAW;AACxC;AAEO,eAAe,MACpB,OAAoB,EACpB,EAAE,MAAM,EAA+C;IAEvD,IAAI;QACF,MAAM,iBAAiB,MAAM;QAC7B,MAAM,aAAa,mBAAmB,eAAe,UAAU,IAAI,IAAI,IAAI;QAC3E,IAAI,CAAC,YAAY;YACf,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,MAAM,EAAE,UAAU,EAAE,KAAK,EAAE,UAAU,EAAE,GAAG,MAAM,UAAU,SAAS;QACnE,IAAI,CAAC,cAAc,CAAC,YAAY;YAC9B,MAAM,aAAa,UAAU,iBAAiB,MAAM,UAAU,cAAc,MAAM;YAClF,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE;YAAM,GAAG;gBAAE,QAAQ;YAAW;QAC3D;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG;QAE1B,IAAI,CAAC,WAAW,CAAC,MAAM;YACrB,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0B,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,MAAM,KAAK,MAAM,IAAA,yHAAK;QACtB,MAAM,WAAW,OAAO,UAAU,CAAC,YAAY,IAAI;QAEnD,oDAAoD;QACpD,MAAM,gBAA0H;YAC9H,SAAS;gBACP,YAAY;gBACZ,OAAO;oBAAE,WAAW;gBAAW;gBAC/B,SAAS;oBACP,iBAAiB,KAAK,GAAG,IAAI;oBAC7B,WAAW,KAAK,OAAO,IAAI;oBAC3B,eAAe,KAAK,UAAU,IAAI;oBAClC,gBAAgB,KAAK,WAAW,IAAI;gBACtC;YACF;YACA,UAAU;gBACR,YAAY;gBACZ,OAAO,WAAW;oBAAE,aAAa;gBAAS,IAAI;oBAAE,WAAW;gBAAW;gBACtE,SAAS;YACX;YACA,YAAY;gBACV,YAAY;gBACZ,OAAO,WAAW;oBAAE,aAAa;gBAAS,IAAI;oBAAE,WAAW;gBAAW;gBACtE,SAAS;YACX;YACA,eAAe;gBACb,YAAY;gBACZ,OAAO,WAAW;oBAAE,aAAa;gBAAS,IAAI;oBAAE,WAAW;gBAAW;gBACtE,SAAS;YACX;QACF;QAEA,MAAM,SAAS,aAAa,CAAC,QAAQ;QACrC,IAAI,CAAC,QAAQ;YACX,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,MAAM,aAAa,GAAG,UAAU,CAAC,OAAO,UAAU;QAClD,MAAM,iBAAiB,OAAO,WAAW,CACvC,OAAO,OAAO,CAAC,OAAO,OAAO,EAAE,MAAM,CAAC,CAAC,CAAC,GAAG,EAAE,GAAK,MAAM;QAG1D,MAAM,SAAS,MAAM,WAAW,SAAS,CAAC,OAAO,KAAK,EAAE;YAAE,MAAM;QAAe;QAE/E,IAAI,OAAO,YAAY,KAAK,GAAG;YAC7B,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QAC9E;QAEA,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS,GAAG,QAAQ,qBAAqB,CAAC;QAAC;IACvF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAAwB,GAC1E;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}